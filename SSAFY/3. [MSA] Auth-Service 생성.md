## í•„ìš” ì˜ì¡´ì„±

```java
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.4.4'
	id 'io.spring.dependency-management' version '1.1.7'
}

group = 'com.s206'
version = '0.0.1-SNAPSHOT'

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(17)
	}
}

repositories {
	mavenCentral()
}

ext {
	set('springCloudVersion', "2024.0.1")
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.boot:spring-boot-starter-security'

	// OAuth2
	implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
	
	// Eureka ë“±ë¡, ConfigClient ë“±ë¡
	implementation 'org.springframework.cloud:spring-cloud-starter-config'
	implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
	
	// ìœ í‹¸
	implementation 'org.springframework.boot:spring-boot-starter-validation'

	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

dependencyManagement {
	imports {
		mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
	}
}

tasks.named('test') {
	useJUnitPlatform()
}

```

---

```
# [ììœ¨ í”„ë¡œì íŠ¸] Auth-Service Eureka ë“±ë¡ ë° í¬íŠ¸ ì„¤ì • ì •ë¦¬

## ëª©í‘œ
- `auth-service`ë¥¼ ëœë¤ í¬íŠ¸ë¡œ ì‹¤í–‰í•˜ë©´ì„œë„ Eurekaì— ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ë“±ë¡ë˜ë„ë¡ êµ¬ì„±
- Gatewayì—ì„œ OAuth redirectë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ì¤€ë¹„

---

## ì„¤ì • ìš”ì•½

### application.yml

```yaml
server:
  port: 0
spring:
  application:
    name: auth-service
  config:
    import: configserver:http://localhost:8888
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: 
            client-secret: 
            redirect-uri: http://localhost:8080/login/oauth2/code/google
            scope: profile, email
        provider:
          google:
            authorization-uri: https://accounts.google.com/o/oauth2/v2/auth
            token-uri: https://oauth2.googleapis.com/token
            user-info-uri: https://www.googleapis.com/oauth2/v3/userinfo
            user-name-attribute: sub
eureka:
  instance:
    instance-id: ${spring.cloud.client.ip-address}:${random.value}
#    prefer-ip-address: true

```

### ğŸ” ì„¤ëª…

| ì„¤ì • | ì„¤ëª… |
| --- | --- |
| `port: 0` | ì‹¤í–‰ ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸ ìë™ í• ë‹¹ |
| `instance-id` | ê³ ìœ  ID ë¶€ì—¬ (IP + ëœë¤ ê°’)ë¡œ Eureka ì¤‘ë³µ ë“±ë¡ ë°©ì§€ |
| `prefer-ip-address` | í˜¸ìŠ¤íŠ¸ë„¤ì„ ëŒ€ì‹  IPë¡œ ë…¸ì¶œë˜ê²Œ ì„¤ì • |

---

## ê²°ê³¼ í™•ì¸

- Eureka Dashboardì—ì„œ `AUTH-SERVICE` ì¸ìŠ¤í„´ìŠ¤ê°€ **2ê°œ ì´ìƒ ë“±ë¡ë¨** í™•ì¸
- ê°ê° `localhost:<uuid>` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„ë¨
- `GATEWAY-SERVICE`ëŠ” ê³ ì • í¬íŠ¸ 8080ìœ¼ë¡œ ì •ìƒ ë“±ë¡

> ì‹¤ì œë¡œ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ëœ¨ê³ , ë®ì–´ì“°ê¸° ì—†ì´ ê°ê° ìœ ì¼í•˜ê²Œ ë“±ë¡ë¨
> 

---

## íŒ

- ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ IntelliJì—ì„œ ì‹¤í–‰í•˜ë ¤ë©´ VM ì˜µì…˜ì— `Dserver.port=0` ì¶”ê°€í•˜ê±°ë‚˜ Run ì„¤ì • ë³µì œ
- `redirect-uri`ëŠ” Gatewayë¥¼ í†µí•´ ê³ ì •ëœ ì£¼ì†Œë¡œ ë°›ì•„ì•¼ OAuthì—ì„œ ì •ìƒ ì½œë°± ì²˜ë¦¬ ê°€ëŠ¥

---

## ë‹¤ìŒ í•  ì¼

- Gateway â†’ `/login/oauth2/code/**` ìš”ì²­ì„ `auth-service`ë¡œ routing ì„¤ì •
- `auth-service`ì—ì„œ OAuth ë¡œê·¸ì¸ ì„±ê³µ í›„ JWT ë°œê¸‰ íë¦„ êµ¬í˜„

```

## ì§€ê¸ˆ `auth-service`ì—ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ ê²ƒë“¤

### 1ï¸âƒ£ **OAuth ë¡œê·¸ì¸ ì„±ê³µ ì—¬ë¶€**

- ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:8080/oauth2/authorization/google` í˜¸ì¶œ
- â†’ Google ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
- â†’ ë¡œê·¸ì¸ í›„ **auth-serviceì˜ ì½œë°± URL** (`/login/oauth2/code/google`) ë„ë‹¬
- â†’ ë¡œê·¸ì¸ ì„±ê³µ í›„ ì¸ì¦ëœ `OAuth2User`ê°€ Principalë¡œ ë“¤ì–´ì˜´

ğŸ” **ì´ê±¸ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê²ƒë“¤:**

- Spring Securityê°€ OAuth flowë¥¼ ì˜ ì²˜ë¦¬í•˜ëŠ”ì§€
- Google APIì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì˜ ë°›ì•„ì˜¤ëŠ”ì§€
- redirect-uri ì •ìƒì¸ì§€

---

### 2ï¸âƒ£ **@AuthenticationPrincipalë¡œ ìœ ì € ì •ë³´ ë°›ê¸°**

```java
@GetMapping("/oauth2/success")
public ResponseEntity<?> success(@AuthenticationPrincipal OAuth2User oAuth2User) {
    log.info("OAuth2User: {}", oAuth2User.getAttributes());
    return ResponseEntity.ok("OAuth ì¸ì¦ ì„±ê³µ");
}

```

- `oAuth2User.getAttributes()`ë¡œ ìœ ì € ì •ë³´ í™•ì¸ ê°€ëŠ¥ (ì´ë©”ì¼, ì´ë¦„ ë“±)
- ì•„ì§ user-serviceë‘ ì—°ë™ ì•ˆ í•´ë„ ì¶©ë¶„íˆ í™•ì¸ ê°€ëŠ¥

---

### 3ï¸âƒ£ **JWT ë°œê¸‰ í…ŒìŠ¤íŠ¸**

- `oAuth2User.getAttribute("email")` ê°™ì€ ê°’ ê¸°ë°˜ìœ¼ë¡œ JWT ë°œê¸‰
- JWT êµ¬ì¡° í™•ì¸ (`header.payload.signature`)
- ë§Œë£Œ ì‹œê°„, ì„œëª… í‚¤, í´ë ˆì„ ë“± ì ê²€

---

## ìœ ì € DBê°€ ì—†ì–´ì„œ "ëª»" í•˜ëŠ” ê²ƒë“¤

| í•­ëª© | ì„¤ëª… |
| --- | --- |
| ìœ ì € ì •ë³´ ì €ì¥ | ì‹ ê·œ ìœ ì € ê°€ì… ì²˜ë¦¬ (DB í•„ìš”) |
| ìœ ì € ì¡´ì¬ ì—¬ë¶€ íŒë‹¨ | ê¸°ì¡´ ìœ ì € ì—¬ë¶€ ì²´í¬ (user-service í•„ìš”) |
| ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ | JWT ìœ íš¨ì„± ê²€ì¦ í›„ ì‚¬ìš©ì ì •ë³´ í™•ì¸ |

---

## í…ŒìŠ¤íŠ¸ í™•ì¸ íë¦„ ì˜ˆì‹œ (Postman or ë¸Œë¼ìš°ì €)

1. `http://localhost:8080/oauth2/authorization/google` â†’ í´ë¦­
2. êµ¬ê¸€ ë¡œê·¸ì¸
3. `/login/oauth2/code/google` â†’ Securityì—ì„œ ìë™ ì²˜ë¦¬
4. `/oauth2/success` â†’ JWT ë°œê¸‰ í›„ ë°˜í™˜ or ìœ ì € ì •ë³´ ë¡œê·¸ ì¶œë ¥

---

## ê²°ë¡ 

ì§€ê¸ˆ ìƒíƒœì—ì„œ `auth-service`ë§Œìœ¼ë¡œë„ **OAuth ë¡œê·¸ì¸ íë¦„ì´ ì™„ì „íˆ ì •ìƒì¸ì§€ ê²€ì¦ ê°€ëŠ¥í•´**.

- ìœ ì € ì„œë¹„ìŠ¤ ì—†ì–´ë„ Googleì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ëŠ”ì§€ í™•ì¸ ê°€ëŠ¥
- JWT ë°œê¸‰ ë¡œì§ê¹Œì§€ ìì²´ì ìœ¼ë¡œ êµ¬í˜„ ê°€ëŠ¥

---
