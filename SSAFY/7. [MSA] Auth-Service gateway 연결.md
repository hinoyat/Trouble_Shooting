## ğŸ“’ [ììœ¨ í”„ë¡œì íŠ¸] OAuth2 ë¡œê·¸ì¸ ì„±ê³µ ì‘ë‹µ ì²˜ë¦¬ ë‹¨ê³„ ì •ë¦¬

### ğŸ“Œ ëª©í‘œ

OAuth2 (Google) ë¡œê·¸ì¸ ì„±ê³µ ì‹œ, ì‚¬ìš©ì ì´ë©”ì¼ì„ í¬í•¨í•œ JSON ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ” íë¦„ì„ ì™„ì„±í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒ.

---

### âœ… 1. `CustomOAuth2User` í´ë˜ìŠ¤ êµ¬í˜„

```java
package com.s206.auth.security;

import lombok.RequiredArgsConstructor;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.oauth2.core.user.OAuth2User;

import java.util.Collection;
import java.util.Map;

@RequiredArgsConstructor
public class CustomOAuth2User implements OAuth2User {

    private final OAuth2User oAuth2User;

    @Override
    public Map<String, Object> getAttributes() {
        return oAuth2User.getAttributes();
    }

    @Override
    public String getName() {
        return oAuth2User.getName();
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return oAuth2User.getAuthorities();
    }

    public String getEmail() {
        return (String) oAuth2User.getAttributes().get("email");
    }
}

```

> ğŸ”¹ ì—­í• : OAuth2Userì˜ ì •ë³´ë¥¼ ê°ì‹¸ê³ , í•„ìš”í•œ ì†ì„± (ì˜ˆ: ì´ë©”ì¼)ì„ ì§ì ‘ ì¶”ì¶œí•  ìˆ˜ ìˆë„ë¡ ì»¤ìŠ¤í„°ë§ˆì´ì§•
> 

---

### âœ… 2. `CustomOAuth2UserService` êµ¬í˜„

```java
package com.s206.auth.service;

import com.s206.auth.security.CustomOAuth2User;
import lombok.RequiredArgsConstructor;
import org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class CustomOAuth2UserService extends DefaultOAuth2UserService {

    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) {
        OAuth2User oAuth2User = super.loadUser(userRequest);
        return new CustomOAuth2User(oAuth2User); // ì»¤ìŠ¤í…€ ë˜í•‘
    }
}

```

> ğŸ”¹ ì—­í• : ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ê¸°ë³¸ ìœ ì € ê°ì²´ë¥¼ CustomOAuth2Userë¡œ ê°ì‹¸ì„œ ë¦¬í„´
> 

---

### âœ… 3. `OAuth2SuccessHandler` êµ¬í˜„

```java
package com.s206.auth.security.handler;

import com.s206.auth.security.CustomOAuth2User;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.stereotype.Component;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;

@Component
@RequiredArgsConstructor
public class OAuth2SuccessHandler implements AuthenticationSuccessHandler {

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
                                        Authentication authentication) throws IOException, ServletException {
        CustomOAuth2User user = (CustomOAuth2User) authentication.getPrincipal();
        String email = user.getEmail();

        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");
        response.getWriter().write("{\"email\": \"" + email + "\"}");
    }
}

```

> ğŸ”¹ ì—­í• : ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ JSON ì‘ë‹µìœ¼ë¡œ ë‚´ë ¤ì£¼ëŠ” í•µì‹¬ ì²˜ë¦¬ë¶€
> 

---

### âœ… 4. `SecurityConfig` ì„¤ì • í™•ì¸

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .csrf(csrf -> csrf.disable())
        .sessionManagement(session -> session
            .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/oauth2/**", "/login/**", "/auth/**").permitAll()
            .anyRequest().authenticated())
        .oauth2Login(oauth2 -> oauth2
            .userInfoEndpoint(userInfo -> userInfo.userService(customOAuth2UserService))
            .successHandler(oAuth2SuccessHandler)); // ğŸ”¥ ì—°ê²° í¬ì¸íŠ¸
    return http.build();
}

```

> ğŸ”¹ ì—­í• : Security íë¦„ ì „ì²´ ì„¤ì • (OAuth2 + SuccessHandler ì—°ë™)
> 

---

### âœ… í…ŒìŠ¤íŠ¸ ë°©ë²•

1. ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†:
    
    `http://localhost:8080/oauth2/authorization/google`
    
2. êµ¬ê¸€ ë¡œê·¸ì¸ â†’ ì„¤ì •ëœ ë¦¬ë””ë ‰ì…˜ URL (`/login/oauth2/code/google`) ë¡œ ì‘ë‹µ ë°›ìŒ
3. ë¦¬ë””ë ‰íŠ¸ â†’ `SuccessHandler` ë°œë™ â†’ ë¸Œë¼ìš°ì €ì— JSON ì‘ë‹µ í™•ì¸
    
    ì˜ˆì‹œ:
    
    ```json
    {
      "email": "example@gmail.com"
    }
    
    ```
    

---

### ğŸ§  ê¸°íƒ€ ì°¸ê³  ì‚¬í•­

- `CustomOAuth2User`ëŠ” í˜„ì¬ Googleë§Œ ê¸°ì¤€ìœ¼ë¡œ `"email"` í‚¤ ì‚¬ìš© ì¤‘
    
    â†’ Kakao, Naver ë“± í™•ì¥ ì‹œ providerë³„ íŒŒì‹± ë¶„ë¦¬ í•„ìš” (enum + parser ì¶”ì²œ)
    
- ì•„ì§ JWT ë°œê¸‰ì€ ë¯¸í¬í•¨ ìƒíƒœ
    
    â†’ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ JwtProvider ì—°ê²°í•˜ì—¬ ì‘ë‹µì— í† í° í¬í•¨ ì˜ˆì •
    

---

## ğŸ“’ [ììœ¨ í”„ë¡œì íŠ¸] Spring Cloud Gateway ë¼ìš°íŒ… ì„¤ì • ì •ë¦¬

### ğŸ“Œ ëª©í‘œ

OAuth2 ë¡œê·¸ì¸ì„ ìœ„í•´ Gatewayì—ì„œ `auth-service`ë¡œ ìš”ì²­ì„ ì œëŒ€ë¡œ ë¼ìš°íŒ…í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•œë‹¤.

---

### âœ… ë¼ìš°íŒ… ì„¤ì • ìœ„ì¹˜

> ğŸ“‚ gateway-service/src/main/resources/application.yml
> 

```yaml
yaml
ë³µì‚¬í¸ì§‘
spring:
  cloud:
    gateway:
      routes:
        - id: auth-service
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/oauth2/**, /login/**, /auth/**

```

---

### ğŸ” ê° í•­ëª© ì„¤ëª…

| í•­ëª© | ì„¤ëª… |
| --- | --- |
| `id` | ë¼ìš°íŒ…ì˜ ì‹ë³„ì (ììœ ë¡­ê²Œ ì‘ì„± ê°€ëŠ¥) |
| `uri` | ë¼ìš°íŒ… ëŒ€ìƒ ì„œë¹„ìŠ¤ ì£¼ì†Œ (`Eureka` ë“±ë¡ ì´ë¦„ ê¸°ì¤€) |
| `predicates` | ì–´ë–¤ ê²½ë¡œë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì„ ë¼ìš°íŒ…í• ì§€ ì§€ì •. **OAuth íë¦„ì— í•„ìš”í•œ ê²½ë¡œ í¬í•¨ í•„ìˆ˜!**ex) `/oauth2/**`, `/login/**`, `/auth/**` |

---
